// ==UserScript==\n// @name         SPRNDS - Reenviar v13.4.7\n// @namespace    http://tampermonkey.net/\n// @version      13.4.7\n// @description  Auto-tuning inteligente + busca por status configurÃ¡vel (PENDING/ERROR) + OtimizaÃ§Ãµes + Fix Race Condition\n// @author       Renato Krebs Rosa\n// @match        *://*/rnds/*\n// @grant        none\n// @updateURL    https://raw.githubusercontent.com/RenatoKR/UserScripts/main/RNDS-Reenviar.user.js\n// @downloadURL  https://raw.githubusercontent.com/RenatoKR/UserScripts/main/RNDS-Reenviar.user.js\n// @supportURL   https://github.com/RenatoKR/UserScripts/issues\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    const VERSAO = '13.4.7';\n\n    // ============================================\n    // âš™ï¸ CONFIGURAÃ‡Ã•ES PADRÃƒO\n    // ============================================\n    const dataAtual = new Date();\n    dataAtual.setHours(dataAtual.getHours() - 3);\n    const hojeStr = dataAtual.toISOString().split('T')[0];\n\n    const CONFIG = {\n        concorrenciaInicial: 100,\n        concorrenciaMaxima: 500,\n        concorrenciaMinima: 5,\n        registrosPorPagina: 500,\n        pausaEntreLotes: 200,\n        timeoutRequisicao: 120000,\n        maxRetentativas: 2,\n        ajusteAutomatico: true,\n        limiteMaximoPaginas: 100,\n        buscarTodasPaginas: true,\n        habilitarCheckpoint: true,\n        salvarCheckpointACada: 10,\n        habilitarFiltroData: false,\n        dataInicio: '2020-01-01',\n        dataFim: hojeStr,\n        autoTuningAgressivo: false,\n        intervaloAnalise: 10,\n        logDetalhado: true,\n        statusBuscar: 'AMBOS' // 'ERROR', 'PENDING', 'AMBOS'\n    };\n\n    // ============================================\n    // ğŸ’¾ GERENCIADOR DE CHECKPOINT PERMANENTE\n    // ============================================\n\n    class CheckpointManager {\n        constructor() {\n            this.STORAGE_KEY = 'RNDS_CHECKPOINT';\n            this.checkpoint = this.carregar() || this.criar();\n            this.idsSet = new Set(this.checkpoint.idsSucesso);\n        }\n\n        criar() {\n            console.log('ğŸ’¾ Criando novo checkpoint vazio');\n            return {\n                timestamp: Date.now(),\n                idsSucesso: [],\n                estatisticas: {\n                    totalSucesso: 0,\n                    totalErro: 0,\n                    totalTimeout: 0,\n                    totalRetentativas: 0\n                },\n                versao: VERSAO,\n                execucoes: []\n            };\n        }\n\n        carregar() {\n            try {\n                const dados = localStorage.getItem(this.STORAGE_KEY);\n                if (dados) {\n                    const checkpoint = JSON.parse(dados);\n                    console.log('ğŸ’¾ Checkpoint carregado:');\n                    console.log(`   â€¢ Data: ${new Date(checkpoint.timestamp).toLocaleString()}`);\n                    console.log(`   â€¢ IDs com SUCESSO: ${checkpoint.idsSucesso.length}`);\n                    console.log(`   â€¢ ExecuÃ§Ãµes anteriores: ${checkpoint.execucoes?.length || 0}`);\n                    return checkpoint;\n                }\n            } catch (e) {\n                console.warn('âš ï¸ Erro ao carregar checkpoint:', e);\n            }\n            return null;\n        }\n\n        iniciarExecucao() {\n            const execucaoAtual = {\n                timestamp: Date.now(),\n                idsSucesso: [],\n                estatisticas: {\n                    totalSucesso: 0,\n                    totalErro: 0,\n                    totalTimeout: 0,\n                    totalRetentativas: 0\n                }\n            };\n\n            this.checkpoint.execucoes = this.checkpoint.execucoes || [];\n            this.checkpoint.execucoes.push(execucaoAtual);\n            this.execucaoAtual = execucaoAtual;\n            this.execucaoAtualIdsSet = new Set();\n\n            console.log('ğŸ’¾ Nova execuÃ§Ã£o iniciada');\n            console.log(`   â€¢ IDs jÃ¡ com sucesso (permanentes): ${this.checkpoint.idsSucesso.length}`);\n            this.salvar();\n        }\n\n        registrarProcessado(id, resultado) {\n            if (!this.checkpoint || !this.execucaoAtual) return;\n\n            if (resultado.status === 'SUCESSO') {\n                if (!this.idsSet.has(id)) {\n                    this.checkpoint.idsSucesso.push(id);\n                    this.idsSet.add(id);\n                    this.checkpoint.estatisticas.totalSucesso++;\n                }\n\n                if (!this.execucaoAtualIdsSet.has(id)) {\n                    this.execucaoAtual.idsSucesso.push(id);\n                    this.execucaoAtualIdsSet.add(id);\n                    this.execucaoAtual.estatisticas.totalSucesso++;\n                }\n\n                if (this.checkpoint.idsSucesso.length % CONFIG.salvarCheckpointACada === 0) {\n                    this.salvar();\n                }\n\n            } else if (resultado.status === 'TIMEOUT') {\n                this.execucaoAtual.estatisticas.totalTimeout++;\n                this.checkpoint.estatisticas.totalTimeout++;\n            } else {\n                this.execucaoAtual.estatisticas.totalErro++;\n                this.checkpoint.estatisticas.totalErro++;\n            }\n\n            if (resultado.tentativa > 1) {\n                this.execucaoAtual.estatisticas.totalRetentativas++;\n                this.checkpoint.estatisticas.totalRetentativas++;\n            }\n        }\n\n        salvar() {\n            if (!this.checkpoint) return;\n\n            try {\n                this.checkpoint.timestamp = Date.now();\n                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.checkpoint));\n                console.log(`ğŸ’¾ Checkpoint salvo: ${this.checkpoint.idsSucesso.length} IDs permanentes com sucesso`);\n            } catch (e) {\n                console.error('âŒ Erro ao salvar checkpoint:', e);\n            }\n        }\n\n        jaTemSucesso(id) {\n            return this.idsSet && this.idsSet.has(id);\n        }\n\n        limpar() {\n            if (confirm(\n                'âš ï¸ ATENÃ‡ÃƒO: LIMPAR CHECKPOINT PERMANENTE\\n\\n' +\n                `VocÃª tem ${this.checkpoint.idsSucesso.length} IDs com sucesso salvos.\\n\\n` +\n                'Ao limpar, TODOS os sucessos anteriores serÃ£o perdidos!\\n' +\n                'Todos os registros serÃ£o processados novamente do zero.\\n\\n' +\n                'Tem certeza que deseja LIMPAR?'\n            )) {\n                localStorage.removeItem(this.STORAGE_KEY);\n                this.checkpoint = this.criar();\n                this.idsSet = new Set();\n                console.log('ğŸ—‘ï¸ Checkpoint limpo - todos os IDs serÃ£o reprocessados');\n                alert('âœ… Checkpoint limpo com sucesso!\\n\\nNa prÃ³xima execuÃ§Ã£o, todos os registros serÃ£o processados.');\n            }\n        }\n\n        getResumo() {\n            if (!this.checkpoint) return null;\n\n            return {\n                dataCheckpoint: new Date(this.checkpoint.timestamp),\n                idsSucesso: this.checkpoint.idsSucesso.length,\n                estatisticas: this.checkpoint.estatisticas,\n                totalExecucoes: this.checkpoint.execucoes?.length || 0\n            };\n        }\n\n        getHistorico() {\n            if (!this.checkpoint || !this.checkpoint.execucoes) return [];\n\n            return this.checkpoint.execucoes.map((exec, idx) => ({\n                numero: idx + 1,\n                data: new Date(exec.timestamp).toLocaleString(),\n                sucessos: exec.idsSucesso.length,\n                erros: exec.estatisticas.totalErro,\n                timeouts: exec.estatisticas.totalTimeout\n            }));\n        }\n    }\n\n    const checkpointManager = new CheckpointManager();\n\n    // ============================================\n    // ğŸ“Š ESTADO GLOBAL\n    // ============================================\n    let estado = {\n        processando: false,\n        pausado: false,\n        cancelado: false,\n        iniciado: null,\n        concorrenciaAtual: CONFIG.concorrenciaInicial,\n        totalBuscados: 0,\n        totalProcessados: 0,\n        totalPulados: 0,\n        totalSucesso: 0,\n        totalErro: 0,\n        totalTimeout: 0,\n        totalRetentativas: 0,\n        paginaAtual: 0,\n        totalPaginas: 0,\n        tempoMedioPorLote: 0,\n        ultimosTempos: [],\n        registros: [],\n        resultados: [],\n        workersAtivos: 0,\n        metricsWorkers: {},\n        metricsLatencia: {\n            historico: [],\n            p50: 0,\n            p95: 0,\n            p99: 0,\n            media: 0,\n            porConcorrencia: {}\n        },\n        ajustesHistorico: []\n    };\n\n    let TOKEN_GLOBAL = null;\n\n    // ============================================\n    // ğŸ”‘ CAPTURA DE TOKEN\n    // ============================================\n\n    function interceptarXHR() {\n        const originalOpen = XMLHttpRequest.prototype.open;\n        const originalSend = XMLHttpRequest.prototype.send;\n        const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;\n\n        XMLHttpRequest.prototype.open = function(method, url) {\n            this._url = url;\n            this._method = method;\n            this._requestHeaders = {};\n            return originalOpen.apply(this, arguments);\n        };\n\n        XMLHttpRequest.prototype.setRequestHeader = function(header, value) {\n            this._requestHeaders[header] = value;\n\n            if (header.toLowerCase() === 'authorization' && value.startsWith('Bearer ')) {\n                TOKEN_GLOBAL = value.replace('Bearer ', '');\n                localStorage.setItem('RNDS_TOKEN', TOKEN_GLOBAL);\n                atualizarBotaoToken(true);\n            }\n\n            return originalSetRequestHeader.apply(this, arguments);\n        };\n\n        XMLHttpRequest.prototype.send = function() {\n            this.addEventListener('load', function() {\n                if (this._requestHeaders && this._requestHeaders['Authorization']) {\n                    const auth = this._requestHeaders['Authorization'];\n                    if (auth.startsWith('Bearer ') && !TOKEN_GLOBAL) {\n                        TOKEN_GLOBAL = auth.replace('Bearer ', '');\n                        localStorage.setItem('RNDS_TOKEN', TOKEN_GLOBAL);\n                        atualizarBotaoToken(true);\n                    }\n                }\n            });\n\n            return originalSend.apply(this, arguments);\n        };\n\n        console.log('âœ… Interceptor XHR instalado');\n    }\n\n    function interceptarFetch() {\n        const originalFetch = window.fetch;\n\n        window.fetch = async function(...args) {\n            const [url, options] = args;\n\n            if (options?.headers) {\n                const headers = options.headers;\n\n                if (headers.Authorization && headers.Authorization.startsWith('Bearer ')) {\n                    TOKEN_GLOBAL = headers.Authorization.replace('Bearer ', '');\n                    localStorage.setItem('RNDS_TOKEN', TOKEN_GLOBAL);\n                    atualizarBotaoToken(true);\n                }\n            }\n\n            return await originalFetch.apply(this, args);\n        };\n\n        console.log('âœ… Interceptor Fetch instalado');\n    }\n\n    function tentarLocalStorage() {\n        const possiveisChaves = ['RNDS_TOKEN', 'auth_token', 'token', 'authorization', 'bearer_token', 'access_token'];\n\n        for (const chave of possiveisChaves) {\n            const valor = localStorage.getItem(chave) || sessionStorage.getItem(chave);\n            if (valor && valor.length > 20) {\n                TOKEN_GLOBAL = valor;\n                console.log(`ğŸ”‘ Token encontrado em storage: ${chave}`);\n                atualizarBotaoToken(true);\n                return true;\n            }\n        }\n\n        return false;\n    }\n\n    function solicitarTokenManual() {\n        const token = prompt(\n            'ğŸ”‘ TOKEN NÃƒO DETECTADO\\n\\n' +\n            'Passos:\\n' +\n            '1. F12 â†’ Network\\n' +\n            '2. FaÃ§a uma pesquisa\\n' +\n            '3. Clique em \"/api/vaccine-sync\"\\n' +\n            '4. Copie o header \"Authorization\"\\n\\n' +\n            'Token:'\n        );\n\n        if (token) {\n            TOKEN_GLOBAL = token.replace('Bearer ', '').trim();\n            localStorage.setItem('RNDS_TOKEN', TOKEN_GLOBAL);\n            console.log('ğŸ”‘ Token fornecido manualmente!');\n            atualizarBotaoToken(true);\n            return true;\n        }\n\n        return false;\n    }\n\n    function capturarToken() {\n        console.log('ğŸ¯ Iniciando captura de token...');\n        interceptarXHR();\n        interceptarFetch();\n\n        if (tentarLocalStorage()) {\n            return;\n        }\n\n        console.log('ğŸ’¡ Aguardando requisiÃ§Ãµes...');\n    }\n\n    function atualizarBotaoToken(capturado) {\n        const botaoToken = document.getElementById('btnVerToken');\n        if (botaoToken) {\n            const icon = botaoToken.querySelector('span.icon-emoji');\n            if (icon) {\n                icon.style.color = capturado ? '#4caf50' : '#ff9800';\n                botaoToken.title = capturado ? 'Token capturado!' : 'Token nÃ£o capturado';\n            }\n        }\n    }\n\n    // ============================================\n    // ğŸŒ API - PAGINAÃ‡ÃƒO COM FILTRO DE DATA E STATUS\n    // ============================================\n\n    async function buscarVacinasComErro(page = 0, limit = 15, status = 'ERROR') {\n        let url = `/rnds/api/vaccine-sync?sort=false:desc&page=${page}&limit=${limit}&sendStatus=${status}`;\n\n        if (CONFIG.habilitarFiltroData) {\n            url += `&between=vaccineDate,${CONFIG.dataInicio},${CONFIG.dataFim}`;\n        }\n\n        console.log(`ğŸ” Buscando pÃ¡gina ${page} (status: ${status})...`);\n        if (CONFIG.habilitarFiltroData) {\n            console.log(`   ğŸ“… PerÃ­odo: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`);\n        }\n\n        try {\n            const response = await fetch(url, {\n                headers: {\n                    'Accept': 'application/json, text/plain, */*',\n                    'Accept-Encoding': 'gzip, deflate, br, zstd',\n                    'Authorization': `Bearer ${TOKEN_GLOBAL}`,\n                    'Cache-Control': 'no-cache',\n                    'accept-language': 'pt-BR',\n                    'DNT': '1',\n                    'Pragma': 'no-cache'\n                }\n            });\n\n            if (!response.ok) {\n                throw new Error(`HTTP ${response.status}`);\n            }\n\n            const dados = await response.json();\n\n            let registros = [];\n            let totalElementos = 0;\n            let totalPaginas = 0;\n\n            if (dados.content && Array.isArray(dados.content)) {\n                registros = dados.content;\n                totalElementos = dados.totalElements || 0;\n                totalPaginas = dados.totalPages || 0;\n            } else if (dados.data && Array.isArray(dados.data)) {\n                registros = dados.data;\n                totalElementos = dados.total || dados.totalElements || 0;\n                totalPaginas = dados.totalPages || 0;\n            } else if (Array.isArray(dados)) {\n                registros = dados;\n                totalElementos = 0;\n                totalPaginas = 0;\n            }\n\n            console.log(`   âœ… ${registros.length} registros retornados`);\n            if (totalElementos > 0) {\n                console.log(`   ğŸ“Š Total na base: ${totalElementos} registros`);\n            }\n            if (totalPaginas > 0) {\n                console.log(`   ğŸ“„ Total de pÃ¡ginas: ${totalPaginas}`);\n            }\n\n            return {\n                content: registros,\n                totalElements: totalElementos,\n                totalPages: totalPaginas,\n                currentPage: page,\n                status: status\n            };\n\n        } catch (erro) {\n            console.error(`âŒ Erro ao buscar pÃ¡gina ${page} (${status}):`, erro);\n            return {\n                content: [],\n                totalElements: 0,\n                totalPages: 0,\n                currentPage: page,\n                status: status\n            };\n        }\n    }\n\n    async function buscarTodasPaginas() {\n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('ğŸ“„ INICIANDO BUSCA PAGINADA');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('ğŸ“Œ EstratÃ©gia: Replicar comportamento da aplicaÃ§Ã£o web');\n        console.log(`ğŸ“Œ Limite por pÃ¡gina: ${CONFIG.registrosPorPagina} registros`);\n\n        const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'ERROR' :\n                           CONFIG.statusBuscar === 'PENDING' ? 'PENDING' :\n                           'ERROR + PENDING';\n        console.log(`ğŸ“Œ Status: ${statusTexto}`);\n\n        if (CONFIG.habilitarFiltroData) {\n            console.log(`ğŸ“… Filtro de perÃ­odo: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`);\n        } else {\n            console.log('ğŸ“… Sem filtro de perÃ­odo (buscando todos)');\n        }\n\n        console.log('');\n\n        const registrosMap = new Map();\n\n        const statusParaBuscar = [];\n        if (CONFIG.statusBuscar === 'ERROR') {\n            statusParaBuscar.push('ERROR');\n        } else if (CONFIG.statusBuscar === 'PENDING') {\n            statusParaBuscar.push('PENDING');\n        } else { // AMBOS\n            statusParaBuscar.push('ERROR', 'PENDING');\n        }\n\n        for (const status of statusParaBuscar) {\n            console.log('');\n            console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`);\n            console.log(`ğŸ“‹ Buscando registros com status: ${status}`);\n            console.log(`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`);\n\n            let page = 0;\n            let totalElementosNaBase = 0;\n            let totalPaginasNaBase = 0;\n\n            while (page < CONFIG.limiteMaximoPaginas) {\n                if (estado.cancelado) {\n                    console.log('âš ï¸ Busca cancelada pelo usuÃ¡rio');\n                    break;\n                }\n\n                estado.paginaAtual = page + 1;\n\n                atualizarModal(\n                    `Buscando ${status} - pÃ¡gina ${page + 1}${totalPaginasNaBase > 0 ? `/${totalPaginasNaBase}` : ''}...`\n                );\n\n                const dados = await buscarVacinasComErro(page, CONFIG.registrosPorPagina, status);\n\n                if (dados.totalElements > 0 && dados.totalElements !== totalElementosNaBase) {\n                    totalElementosNaBase = dados.totalElements;\n                    console.log(`ğŸ“Š API reporta: ${totalElementosNaBase} registros no total (${status})`);\n                }\n\n                if (dados.totalPages > 0 && dados.totalPages !== totalPaginasNaBase) {\n                    totalPaginasNaBase = dados.totalPages;\n                    estado.totalPaginas = totalPaginasNaBase;\n                    console.log(`ğŸ“„ API reporta: ${totalPaginasNaBase} pÃ¡ginas no total (${status})`);\n                }\n\n                if (!dados.content || dados.content.length === 0) {\n                    console.log('');\n                    console.log(`âœ… FIM: PÃ¡gina vazia (sem registros ${status})`);\n                    break;\n                }\n\n                const qtdNaPagina = dados.content.length;\n                \n                dados.content.forEach(reg => {\n                    if (!registrosMap.has(reg.id)) {\n                        registrosMap.set(reg.id, reg);\n                    }\n                });\n                \n                estado.totalBuscados = registrosMap.size;\n\n                console.log(`   ğŸ’¾ Acumulado Ãºnico: ${registrosMap.size} registros`);\n\n                if (qtdNaPagina < CONFIG.registrosPorPagina) {\n                    console.log('');\n                    console.log(`âœ… FIM: Ãšltima pÃ¡gina detectada (${qtdNaPagina} < ${CONFIG.registrosPorPagina})`);\n                    break;\n                }\n\n                if (totalPaginasNaBase > 0 && (page + 1) >= totalPaginasNaBase) {\n                    console.log('');\n                    console.log(`âœ… FIM: Todas as ${totalPaginasNaBase} pÃ¡ginas foram processadas`);\n                    break;\n                }\n\n                if (totalElementosNaBase > 0 && registrosMap.size >= totalElementosNaBase && statusParaBuscar.length === 1) {\n                    console.log('');\n                    console.log(`âœ… FIM: Todos os ${totalElementosNaBase} registros foram buscados`);\n                    break;\n                }\n\n                page++;\n                await new Promise(r => setTimeout(r, 100));\n            }\n\n            if (page >= CONFIG.limiteMaximoPaginas) {\n                console.warn('');\n                console.warn(`âš ï¸ ATENÃ‡ÃƒO: Limite de seguranÃ§a atingido (${CONFIG.limiteMaximoPaginas} pÃ¡ginas) para ${status}`);\n            }\n        }\n\n        const todosRegistros = Array.from(registrosMap.values());\n\n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('ğŸ“Š BUSCA FINALIZADA');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log(`âœ… Registros Ãºnicos obtidos: ${todosRegistros.length}`);\n        console.log(`ğŸ“‹ Status buscados: ${statusTexto}`);\n        if (CONFIG.habilitarFiltroData) {\n            console.log(`ğŸ“… PerÃ­odo filtrado: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`);\n        }\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('');\n\n        return todosRegistros;\n    }\n\n    function registrarLatencia(tempo, isTimeout, statusCode) {\n        const metrica = {\n            tempo: tempo,\n            workers: estado.concorrenciaAtual,\n            timeout: isTimeout,\n            statusCode: statusCode,\n            timestamp: Date.now()\n        };\n        \n        estado.metricsLatencia.historico.push(metrica);\n        \n        if (estado.metricsLatencia.historico.length > 100) {\n            estado.metricsLatencia.historico.shift();\n        }\n        \n        const nivel = estado.concorrenciaAtual;\n        if (!estado.metricsLatencia.porConcorrencia[nivel]) {\n            estado.metricsLatencia.porConcorrencia[nivel] = [];\n        }\n        estado.metricsLatencia.porConcorrencia[nivel].push(metrica);\n        \n        if (estado.metricsLatencia.porConcorrencia[nivel].length > 50) {\n            estado.metricsLatencia.porConcorrencia[nivel].shift();\n        }\n    }\n\n    async function reenviarVacina(registro, tentativa = 1) {\n        const url = '/rnds/api/vaccine-sync/send-register';\n        const inicioReq = Date.now();\n\n        try {\n            const controller = new AbortController();\n            const timeoutId = setTimeout(() => controller.abort(), CONFIG.timeoutRequisicao);\n\n            const response = await fetch(url, {\n                method: 'POST',\n                headers: {\n                    'Authorization': `Bearer ${TOKEN_GLOBAL}`,\n                    'Content-Type': 'application/json',\n                    'Accept': 'application/json, text/plain, */*',\n                    'accept-language': 'pt-BR'\n                },\n                body: JSON.stringify({ id: registro.id }),\n                signal: controller.signal\n            });\n\n            clearTimeout(timeoutId);\n            \n            const latencia = Date.now() - inicioReq;\n            registrarLatencia(latencia, false, response.status);\n\n            const resultado = {\n                id: registro.id,\n                cpf: registro.pacientCpf || registro.patientCpf || 'N/A',\n                vacina: registro.vaccineDescription || registro.vaccine || 'N/A',\n                status: response.ok ? 'SUCESSO' : 'ERRO',\n                statusCode: response.status,\n                tentativa: tentativa,\n                timestamp: new Date().toISOString(),\n                latencia: latencia\n            };\n\n            if (response.ok) {\n                estado.totalSucesso++;\n                if (CONFIG.habilitarCheckpoint) {\n                    checkpointManager.registrarProcessado(registro.id, resultado);\n                }\n            } else {\n                if (tentativa < CONFIG.maxRetentativas) {\n                    estado.totalRetentativas++;\n                    await new Promise(r => setTimeout(r, 1000));\n                    return await reenviarVacina(registro, tentativa + 1);\n                }\n                estado.totalErro++;\n                resultado.erro = await response.text();\n                if (CONFIG.habilitarCheckpoint) {\n                    checkpointManager.registrarProcessado(registro.id, resultado);\n                }\n            }\n\n            return resultado;\n\n        } catch (erro) {\n            const isTimeout = erro.name === 'AbortError';\n            const latencia = Date.now() - inicioReq;\n            \n            if (isTimeout) {\n                registrarLatencia(latencia, true, 0);\n            }\n\n            if (tentativa < CONFIG.maxRetentativas && !isTimeout) {\n                estado.totalRetentativas++;\n                await new Promise(r => setTimeout(r, 1000));\n                return await reenviarVacina(registro, tentativa + 1);\n            }\n\n            if (isTimeout) {\n                estado.totalTimeout++;\n            } else {\n                estado.totalErro++;\n            }\n\n            const resultado = {\n                id: registro.id,\n                cpf: registro.pacientCpf || registro.patientCpf || 'N/A',\n                vacina: registro.vaccineDescription || registro.vaccine || 'N/A',\n                status: isTimeout ? 'TIMEOUT' : 'ERRO',\n                statusCode: 0,\n                erro: erro.message,\n                tentativa: tentativa,\n                timestamp: new Date().toISOString(),\n                latencia: latencia\n            };\n\n            if (CONFIG.habilitarCheckpoint) {\n                checkpointManager.registrarProcessado(registro.id, resultado);\n            }\n\n            return resultado;\n        }\n    }\n\n    function percentil(arr, p) {\n        if (arr.length === 0) return 0;\n        const sorted = [...arr].sort((a, b) => a - b);\n        const index = Math.max(0, Math.ceil(sorted.length * p) - 1);\n        return sorted[index];\n    }\n\n    function analisarPerformance() {\n        const hist = estado.metricsLatencia.historico;\n        \n        if (hist.length < 10) {\n            return null;\n        }\n        \n        const temposValidos = hist\n            .filter(m => !m.timeout)\n            .map(m => m.tempo);\n        \n        const totalTimeouts = hist.filter(m => m.timeout).length;\n        const taxaTimeout = (totalTimeouts / hist.length) * 100;\n        \n        if (temposValidos.length === 0) {\n            return {\n                workers: estado.concorrenciaAtual,\n                p50: CONFIG.timeoutRequisicao,\n                p95: CONFIG.timeoutRequisicao,\n                p99: CONFIG.timeoutRequisicao,\n                media: CONFIG.timeoutRequisicao,\n                taxaTimeout: 100,\n                throughputTeorico: 0,\n                amostra: hist.length\n            };\n        }\n        \n        const p50 = percentil(temposValidos, 0.50);\n        const p95 = percentil(temposValidos, 0.95);\n        const p99 = percentil(temposValidos, 0.99);\n        const media = temposValidos.reduce((a, b) => a + b, 0) / temposValidos.length;\n        \n        const throughputTeorico = estado.concorrenciaAtual / (media / 1000);\n        \n        return {\n            workers: estado.concorrenciaAtual,\n            p50: Math.round(p50),\n            p95: Math.round(p95),\n            p99: Math.round(p99),\n            media: Math.round(media),\n            taxaTimeout: parseFloat(taxaTimeout.toFixed(2)),\n            throughputTeorico: parseFloat(throughputTeorico.toFixed(2)),\n            amostra: hist.length\n        };\n    }\n\n    function detectarTendenciaLatencia() {\n        const hist = estado.metricsLatencia.historico;\n        if (hist.length < 20) return 'estavel';\n        \n        const primeira_metade = hist.slice(0, Math.floor(hist.length / 2))\n            .filter(m => !m.timeout)\n            .map(m => m.tempo);\n        \n        const segunda_metade = hist.slice(Math.floor(hist.length / 2))\n            .filter(m => !m.timeout)\n            .map(m => m.tempo);\n        \n        if (primeira_metade.length === 0 || segunda_metade.length === 0) {\n            return 'estavel';\n        }\n        \n        const media1 = primeira_metade.reduce((a, b) => a + b, 0) / primeira_metade.length;\n        const media2 = segunda_metade.reduce((a, b) => a + b, 0) / segunda_metade.length;\n        \n        const variacao = ((media2 - media1) / media1) * 100;\n        \n        if (variacao > 20) return 'crescente';\n        if (variacao < -20) return 'decrescente';\n        return 'estavel';\n    }\n\n    async function processarComPool(registros) {\n        const inicio = Date.now();\n        const resultados = [];\n        const resultadosRecentes = [];\n        \n        let proximoIndice = 0;\n        const totalRegistros = registros.length;\n        \n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log(`ğŸŠ POOL DE WORKERS DINÃ‚MICO: ${estado.concorrenciaAtual} workers`);\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('ğŸ’¡ Cada worker pega o prÃ³ximo item assim que termina');\n        console.log('ğŸ’¡ Zero tempo ocioso - mÃ¡xima eficiÃªncia');\n        console.log('âœ¨ Auto-tuning inteligente com anÃ¡lise de latÃªncia');\n        console.log('');\n        \n        async function worker(workerId) {\n            const metricas = {\n                processados: 0,\n                sucessos: 0,\n                erros: 0,\n                timeouts: 0,\n                tempoTotal: 0,\n                inicioWorker: Date.now()\n            };\n            \n            estado.metricsWorkers[workerId] = metricas;\n            estado.workersAtivos++;\n            \n            console.log(`ğŸŸ¢ Worker #${workerId} iniciado`);\n            \n            while (true) {\n                if (estado.workersAtivos > estado.concorrenciaAtual) {\n                    if (CONFIG.logDetalhado) {\n                        console.log(`ğŸ“‰ Worker #${workerId} encerrado (reduÃ§Ã£o de concorrÃªncia)`);\n                    }\n                    break;\n                }\n\n                while (estado.pausado && !estado.cancelado) {\n                    await new Promise(r => setTimeout(r, 500));\n                }\n                \n                if (estado.cancelado) {\n                    console.log(`ğŸ›‘ Worker #${workerId} cancelado`);\n                    break;\n                }\n                \n                // âœ¨ FIX RACE CONDITION: Garantir operaÃ§Ã£o atÃ´mica de captura do Ã­ndice\n                let indice;\n                // NÃ£o precisamos de lock real no JS do browser pois Ã© single-threaded, \n                // mas precisamos garantir que o incremento aconteÃ§a ANTES de qualquer await\n                indice = proximoIndice++;\n                \n                if (indice >= totalRegistros) {\n                    break;\n                }\n                \n                const registro = registros[indice];\n                \n                if (CONFIG.habilitarCheckpoint && checkpointManager.jaTemSucesso(registro.id)) {\n                    estado.totalPulados++;\n                    continue;\n                }\n                \n                const inicioRegistro = Date.now();\n                const resultado = await reenviarVacina(registro);\n                const tempoRegistro = Date.now() - inicioRegistro;\n                \n                metricas.processados++;\n                metricas.tempoTotal += tempoRegistro;\n                \n                if (resultado.status === 'SUCESSO') {\n                    metricas.sucessos++;\n                } else if (resultado.status === 'TIMEOUT') {\n                    metricas.timeouts++;\n                } else {\n                    metricas.erros++;\n                }\n                \n                resultados.push(resultado);\n                resultadosRecentes.push(resultado);\n                estado.totalProcessados++;\n                \n                if (estado.totalProcessados % 5 === 0) {\n                    atualizarModal();\n                }\n                \n                if (CONFIG.ajusteAutomatico && resultadosRecentes.length >= CONFIG.intervaloAnalise) {\n                    ajustarConcorrencia(resultadosRecentes);\n                    resultadosRecentes.length = 0;\n                }\n            }\n            \n            estado.workersAtivos--;\n            metricas.tempoTotal = Date.now() - metricas.inicioWorker;\n            \n            const velocidade = metricas.tempoTotal > 0 \n                ? (metricas.processados / (metricas.tempoTotal / 1000)).toFixed(2)\n                : 0;\n            \n            console.log(`ğŸŸ  Worker #${workerId} finalizado:`);\n            console.log(`   â€¢ Processados: ${metricas.processados}`);\n            console.log(`   â€¢ Sucessos: ${metricas.sucessos}`);\n            console.log(`   â€¢ Erros: ${metricas.erros}`);\n            console.log(`   â€¢ Timeouts: ${metricas.timeouts}`);\n            console.log(`   â€¢ Tempo: ${(metricas.tempoTotal / 1000).toFixed(2)}s`);\n            console.log(`   â€¢ Velocidade: ${velocidade} reg/s`);\n        }\n        \n        const workersPromises = new Set();\n        let proximoWorkerId = 1;\n        \n        while (proximoIndice < totalRegistros && !estado.cancelado) {\n            while (estado.workersAtivos < estado.concorrenciaAtual && proximoIndice < totalRegistros) {\n                const id = proximoWorkerId++;\n                const p = worker(id).finally(() => workersPromises.delete(p));\n                workersPromises.add(p);\n            }\n            await new Promise(r => setTimeout(r, 250));\n        }\n        \n        while (workersPromises.size > 0) {\n            await Promise.all(Array.from(workersPromises)); // âœ¨ PRECAUÃ‡ÃƒO ADICIONAL para resolver Promises dinÃ¢micas\n        }\n        \n        if (CONFIG.habilitarCheckpoint) {\n            checkpointManager.salvar();\n        }\n        \n        const tempoTotal = Date.now() - inicio;\n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log(`âœ… POOL FINALIZADO: ${(tempoTotal / 1000).toFixed(2)}s`);\n        console.log(`âš¡ Velocidade mÃ©dia: ${((resultados.length / (tempoTotal / 1000)) * 60).toFixed(2)} reg/min`);\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('');\n        \n        return resultados;\n    }\n\n    function ajustarConcorrencia(resultadosRecentes) {\n        if (resultadosRecentes.length === 0) return;\n        \n        const analise = analisarPerformance();\n        \n        if (!analise) {\n            if (CONFIG.logDetalhado) {\n                console.log('ğŸ“Š Dados insuficientes para anÃ¡lise (< 10 amostras)');\n            }\n            return;\n        }\n        \n        const concorrenciaAnterior = estado.concorrenciaAtual;\n        const tendencia = detectarTendenciaLatencia();\n        \n        if (CONFIG.logDetalhado) {\n            console.log('');\n            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n            console.log('ğŸ“Š ANÃLISE DE PERFORMANCE DETALHADA');\n            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n            console.log(`âš™ï¸  Workers Atual: ${analise.workers}`);\n            console.log(`ğŸ“ˆ LatÃªncias:`);\n            console.log(`   â€¢ P50 (mediana): ${analise.p50}ms`);\n            console.log(`   â€¢ P95: ${analise.p95}ms`);\n            console.log(`   â€¢ P99: ${analise.p99}ms`);\n            console.log(`   â€¢ MÃ©dia: ${analise.media}ms`);\n            console.log(`â±ï¸  Timeout Config: ${CONFIG.timeoutRequisicao}ms`);\n            console.log(`âŒ Taxa Timeout: ${analise.taxaTimeout}%`);\n            console.log(`ğŸ“‰ TendÃªncia: ${tendencia}`);\n            console.log(`âš¡ Throughput TeÃ³rico: ${analise.throughputTeorico} req/s`);\n            console.log(`ğŸ“Š Amostra: ${analise.amostra} requisiÃ§Ãµes`);\n        }\n        \n        let decisao = null;\n        let novoValor = concorrenciaAnterior;\n        \n        if (analise.p95 > CONFIG.timeoutRequisicao * 0.85) {\n            const reducao = Math.ceil(concorrenciaAnterior * 0.3);\n            novoValor = Math.max(\n                concorrenciaAnterior - reducao,\n                CONFIG.concorrenciaMinima\n            );\n            decisao = {\n                acao: 'REDUÃ‡ÃƒO_CRÃTICA',\n                razao: `P95 (${analise.p95}ms) muito prÃ³ximo do timeout (${CONFIG.timeoutRequisicao}ms)`,\n                reducao: reducao\n            };\n        }\n        else if (analise.taxaTimeout > 5) {\n            novoValor = Math.max(\n                concorrenciaAnterior - 5,\n                CONFIG.concorrenciaMinima\n            );\n            decisao = {\n                acao: 'REDUÃ‡ÃƒO_POR_TIMEOUT',\n                razao: `Taxa de timeout (${analise.taxaTimeout}%) acima de 5%`,\n                reducao: 5\n            };\n        }\n        else if (analise.p95 > CONFIG.timeoutRequisicao * 0.6 && tendencia === 'crescente') {\n            novoValor = Math.max(\n                concorrenciaAnterior - 3,\n                CONFIG.concorrenciaMinima\n            );\n            decisao = {\n                acao: 'REDUÃ‡ÃƒO_PREVENTIVA',\n                razao: `P95 (${analise.p95}ms) alto e latÃªncia crescente`,\n                reducao: 3\n            };\n        }\n        else if (analise.taxaTimeout > 2) {\n            novoValor = Math.max(\n                concorrenciaAnterior - 2,\n                CONFIG.concorrenciaMinima\n            );\n            decisao = {\n                acao: 'REDUÃ‡ÃƒO_MODERADA',\n                razao: `Taxa de timeout moderada (${analise.taxaTimeout}%)`,\n                reducao: 2\n            };\n        }\n        else if (\n            analise.p95 < CONFIG.timeoutRequisicao * 0.3 &&\n            analise.taxaTimeout < 0.5 &&\n            tendencia !== 'crescente' &&\n            concorrenciaAnterior < CONFIG.concorrenciaMaxima\n        ) {\n            novoValor = Math.min(\n                concorrenciaAnterior + 5,\n                CONFIG.concorrenciaMaxima\n            );\n            decisao = {\n                acao: 'AUMENTO_SEGURO',\n                razao: `P95 baixo (${analise.p95}ms), servidor respondendo rÃ¡pido`,\n                aumento: 5\n            };\n        }\n        else if (\n            analise.p95 < CONFIG.timeoutRequisicao * 0.5 &&\n            analise.taxaTimeout < 1 &&\n            tendencia === 'decrescente' &&\n            concorrenciaAnterior < CONFIG.concorrenciaMaxima\n        ) {\n            novoValor = Math.min(\n                concorrenciaAnterior + 3,\n                CONFIG.concorrenciaMaxima\n            );\n            decisao = {\n                acao: 'AUMENTO_CONSERVADOR',\n                razao: `LatÃªncia decrescente, performance boa`,\n                aumento: 3\n            };\n        }\n        else {\n            decisao = {\n                acao: 'MANTER',\n                razao: `Ponto de equilÃ­brio (P95: ${analise.p95}ms, Timeout: ${analise.taxaTimeout}%)`,\n            };\n        }\n        \n        if (novoValor !== concorrenciaAnterior) {\n            estado.concorrenciaAtual = novoValor;\n            \n            estado.ajustesHistorico.push({\n                timestamp: Date.now(),\n                de: concorrenciaAnterior,\n                para: novoValor,\n                decisao: decisao,\n                analise: analise\n            });\n            \n            if (CONFIG.logDetalhado) {\n                console.log('');\n                console.log(`ğŸ”„ DECISÃƒO: ${decisao.acao}`);\n                console.log(`ğŸ“ RazÃ£o: ${decisao.razao}`);\n                console.log(`âš™ï¸  Workers: ${concorrenciaAnterior} â†’ ${novoValor}`);\n                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n                console.log('');\n            } else {\n                console.log(`ğŸ”„ ${decisao.acao}: ${concorrenciaAnterior} â†’ ${novoValor} workers`);\n            }\n        } else {\n            if (CONFIG.logDetalhado) {\n                console.log(`âœ… DECISÃƒO: ${decisao.acao}`);\n                console.log(`ğŸ“ RazÃ£o: ${decisao.razao}`);\n                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n                console.log('');\n            }\n        }\n        \n        atualizarModal();\n    }\n\n    // ============================================\n    // ğŸ® CONTROLE\n    // ============================================\n\n    function pausarProcessamento() {\n        estado.pausado = true;\n        console.log('â¸ï¸ Processamento pausado');\n        if (CONFIG.habilitarCheckpoint) {\n            checkpointManager.salvar();\n        }\n        atualizarBotoesDuranteExecucao();\n    }\n\n    function continuarProcessamento() {\n        estado.pausado = false;\n        console.log('â–¶ï¸ Processamento retomado');\n        atualizarBotoesDuranteExecucao();\n    }\n\n    function cancelarProcessamento() {\n        if (confirm(\n            'âš ï¸ Confirma cancelar o processamento?\\n\\n' +\n            'Os registros jÃ¡ enviados com sucesso nÃ£o serÃ£o revertidos.\\n' +\n            'O checkpoint PERMANENTE serÃ¡ mantido.\\n' +\n            'VocÃª pode continuar em outra execuÃ§Ã£o.\\n\\n' +\n            'Cancelar?'\n        )) {\n            estado.cancelado = true;\n            estado.pausado = false;\n            if (CONFIG.habilitarCheckpoint) {\n                checkpointManager.salvar();\n            }\n            console.log('ğŸ›‘ Processamento cancelado');\n            console.log(`ğŸ’¾ Checkpoint mantÃ©m ${checkpointManager.checkpoint.idsSucesso.length} IDs com sucesso`);\n        }\n    }\n\n    window.ajustarWorkers = function(delta) {\n        const novo = estado.concorrenciaAtual + delta;\n        if (novo < CONFIG.concorrenciaMinima) {\n            alert(`âš ï¸ MÃ­nimo: ${CONFIG.concorrenciaMinima} workers`);\n            return;\n        }\n        if (novo > CONFIG.concorrenciaMaxima) {\n            alert(`âš ï¸ MÃ¡ximo: ${CONFIG.concorrenciaMaxima} workers`);\n            return;\n        }\n        estado.concorrenciaAtual = novo;\n        console.log(`âš¡ Workers ajustado manualmente: ${novo}`);\n        atualizarModal();\n    };\n\n    window.aplicarLimitesWorkers = function() {\n        const minInput = document.getElementById('workersMin');\n        const maxInput = document.getElementById('workersMax');\n\n        const min = parseInt(minInput.value);\n        const max = parseInt(maxInput.value);\n\n        if (min < 1 || max < 1) {\n            alert('âš ï¸ Valores devem ser maiores que 0');\n            return;\n        }\n\n        if (min > max) {\n            alert('âš ï¸ MÃ­nimo nÃ£o pode ser maior que mÃ¡ximo');\n            return;\n        }\n\n        CONFIG.concorrenciaMinima = min;\n        CONFIG.concorrenciaMaxima = max;\n\n        if (estado.concorrenciaAtual < min) {\n            estado.concorrenciaAtual = min;\n        }\n        if (estado.concorrenciaAtual > max) {\n            estado.concorrenciaAtual = max;\n        }\n\n        console.log(`âš™ï¸ Limites atualizados: ${min} - ${max}`);\n        console.log(`âš¡ Workers atual: ${estado.concorrenciaAtual}`);\n\n        alert(`âœ… Limites aplicados!\\n\\nMÃ­n: ${min}\\nMÃ¡x: ${max}\\nAtual: ${estado.concorrenciaAtual}`);\n        atualizarModal();\n    };\n\n    async function iniciarReenvioAPI() {\n        if (estado.processando) {\n            alert('âš ï¸ JÃ¡ existe um processamento em andamento!');\n            return;\n        }\n\n        if (!TOKEN_GLOBAL) {\n            const tentarManual = confirm(\n                'âš ï¸ TOKEN NÃƒO DETECTADO\\n\\n' +\n                'Deseja fornecÃª-lo manualmente?'\n            );\n\n            if (tentarManual) {\n                if (!solicitarTokenManual()) {\n                    alert('âŒ Token necessÃ¡rio!');\n                    return;\n                }\n            } else {\n                alert('âŒ Token necessÃ¡rio!\\n\\nDica: FaÃ§a uma pesquisa no sistema.');\n                return;\n            }\n        }\n\n        const resumo = checkpointManager.getResumo();\n        let mensagemInicial = 'ğŸš€ Iniciar reenvio via API?\\n\\n';\n\n        if (resumo && resumo.idsSucesso > 0) {\n            mensagemInicial +=\n                `ğŸ’¾ CHECKPOINT ATIVO:\\n` +\n                `   â€¢ ${resumo.idsSucesso} IDs jÃ¡ tiveram SUCESSO\\n` +\n                `   â€¢ Esses IDs serÃ£o PULADOS automaticamente\\n` +\n                `   â€¢ Apenas registros sem sucesso serÃ£o processados\\n\\n`;\n        }\n\n        const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'apenas ERROR' :\n                           CONFIG.statusBuscar === 'PENDING' ? 'apenas PENDING' :\n                           'ERROR + PENDING';\n\n        mensagemInicial +=\n            `âš™ï¸ CONFIGURAÃ‡Ã•ES:\\n` +\n            `   â€¢ Status: ${statusTexto}\\n` +\n            `   â€¢ Pool de Workers: ${CONFIG.concorrenciaInicial} â†’ ${CONFIG.concorrenciaMaxima}\\n` +\n            `   â€¢ Auto-tuning Inteligente: ${CONFIG.ajusteAutomatico ? 'ATIVO' : 'DESATIVADO'}\\n` +\n            `   â€¢ Retry: ${CONFIG.maxRetentativas}x\\n` +\n            `   â€¢ Checkpoint: ${CONFIG.habilitarCheckpoint ? 'ATIVO (permanente)' : 'DESATIVADO'}\\n`;\n\n        if (CONFIG.habilitarFiltroData) {\n            mensagemInicial +=\n                `   â€¢ Filtro de PerÃ­odo: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}\\n`;\n        } else {\n            mensagemInicial += `   â€¢ Filtro de PerÃ­odo: DESATIVADO (todos)\\n`;\n        }\n        mensagemInicial += '\\n';\n\n        if (resumo && resumo.totalExecucoes > 0) {\n            mensagemInicial += `ğŸ“Š ExecuÃ§Ãµes anteriores: ${resumo.totalExecucoes}\\n\\n`;\n        }\n\n        mensagemInicial += 'Continuar?';\n\n        if (!confirm(mensagemInicial)) {\n            return;\n        }\n\n        estado = {\n            processando: true,\n            pausado: false,\n            cancelado: false,\n            iniciado: Date.now(),\n            concorrenciaAtual: CONFIG.concorrenciaInicial,\n            totalBuscados: 0,\n            totalProcessados: 0,\n            totalPulados: 0,\n            totalSucesso: 0,\n            totalErro: 0,\n            totalTimeout: 0,\n            totalRetentativas: 0,\n            paginaAtual: 0,\n            totalPaginas: 0,\n            tempoMedioPorLote: 0,\n            ultimosTempos: [],\n            registros: [],\n            resultados: [],\n            workersAtivos: 0,\n            metricsWorkers: {},\n            metricsLatencia: {\n                historico: [],\n                p50: 0,\n                p95: 0,\n                p99: 0,\n                media: 0,\n                porConcorrencia: {}\n            },\n            ajustesHistorico: []\n        };\n\n        criarModal();\n        console.log(`ğŸš€ Iniciando reenvio via API Direct v${VERSAO}...`);\n        console.log(`ğŸŠ Pool de Workers DinÃ¢mico habilitado`);\n        console.log(`âœ¨ Auto-tuning inteligente com anÃ¡lise de latÃªncia`);\n        console.log(`ğŸ“‹ Status a buscar: ${statusTexto}`);\n        console.log(`ğŸ’¾ Checkpoint permanente: ${resumo ? resumo.idsSucesso : 0} IDs com sucesso`);\n        if (CONFIG.habilitarFiltroData) {\n            console.log(`ğŸ“… PerÃ­odo: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`);\n        }\n\n        try {\n            atualizarModal('Buscando registros...');\n\n            if (CONFIG.habilitarCheckpoint) {\n                checkpointManager.iniciarExecucao();\n            }\n\n            estado.registros = await buscarTodasPaginas();\n            estado.totalBuscados = estado.registros.length;\n\n            if (estado.cancelado) {\n                fecharModal();\n                estado.processando = false;\n                return;\n            }\n\n            if (estado.totalBuscados === 0) {\n                let msg = 'âš ï¸ NÃ£o hÃ¡ registros para processar!';\n                msg += `\\n\\nStatus configurado: ${statusTexto}`;\n                if (CONFIG.habilitarFiltroData) {\n                    msg += `\\nPerÃ­odo: ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`;\n                }\n                msg += '\\n\\nDica: Verifique as configuraÃ§Ãµes de status e perÃ­odo.';\n                alert(msg);\n                fecharModal();\n                estado.processando = false;\n                return;\n            }\n\n            console.log(`ğŸ“Š Total a processar: ${estado.totalBuscados} registros`);\n\n            if (resumo && resumo.idsSucesso > 0) {\n                console.log(`ğŸ’¾ Checkpoint removerÃ¡ parte do trabalho caso os IDs coincidam com sucesso prÃ©vio.`);\n            }\n\n            atualizarModal('Processando com pool de workers...');\n\n            const resultados = await processarComPool(estado.registros);\n            estado.resultados = resultados;\n\n            if (!estado.cancelado) {\n                finalizarProcessamento();\n            } else {\n                finalizarProcessamento(true);\n            }\n\n        } catch (erro) {\n            console.error('âŒ Erro:', erro);\n            alert(`âŒ Erro: ${erro.message}`);\n            estado.processando = false;\n            fecharModal();\n        }\n    }\n\n    function finalizarProcessamento(cancelado = false) {\n        const tempoTotal = Math.floor((Date.now() - estado.iniciado) / 1000);\n        const velocidade = tempoTotal > 0 ? Math.round((estado.totalProcessados / tempoTotal) * 60) : 0;\n        const taxaSucesso = estado.totalProcessados > 0\n            ? ((estado.totalSucesso / estado.totalProcessados) * 100).toFixed(1)\n            : 0;\n\n        const resumo = checkpointManager.getResumo();\n        const analise = analisarPerformance();\n\n        const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'ERROR' :\n                           CONFIG.statusBuscar === 'PENDING' ? 'PENDING' :\n                           'ERROR + PENDING';\n\n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log(cancelado ? 'âš ï¸ PROCESSAMENTO CANCELADO!' : 'ğŸ PROCESSAMENTO FINALIZADO!');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('  ESTA EXECUÃ‡ÃƒO:');\n        console.log(`    âœ… Sucesso: ${estado.totalSucesso}`);\n        console.log(`    âŒ Erros: ${estado.totalErro}`);\n        console.log(`    â±ï¸ Timeouts: ${estado.totalTimeout}`);\n        console.log(`    â­ï¸ Pulados (sucesso anterior): ${estado.totalPulados}`);\n        console.log(`    ğŸ”„ Retentativas: ${estado.totalRetentativas}`);\n        console.log(`    â±ï¸ Tempo: ${tempoTotal}s (${Math.floor(tempoTotal/60)}min)`);\n        console.log(`    âš¡ Velocidade: ${velocidade} reg/min`);\n        console.log(`    ğŸ“Š Taxa: ${taxaSucesso}%`);\n        console.log(`    ğŸ“‹ Status buscados: ${statusTexto}`);\n        \n        if (analise) {\n            console.log('');\n            console.log('  MÃ‰TRICAS DE LATÃŠNCIA:');\n            console.log(`    ğŸ“Š P50: ${analise.p50}ms | P95: ${analise.p95}ms | P99: ${analise.p99}ms`);\n            console.log(`    âš¡ Throughput final: ${analise.throughputTeorico} req/s`);\n        }\n        \n        console.log('');\n        console.log('  CHECKPOINT PERMANENTE:');\n        console.log(`    ğŸ’¾ Total IDs com sucesso: ${resumo.idsSucesso}`);\n        console.log(`    ğŸ“Š Total execuÃ§Ãµes: ${resumo.totalExecucoes}`);\n        \n        if (estado.ajustesHistorico.length > 0) {\n            console.log('');\n            console.log('  AUTO-TUNING:');\n            console.log(`    ğŸ”„ Total de ajustes: ${estado.ajustesHistorico.length}`);\n        }\n        \n        if (CONFIG.habilitarFiltroData) {\n            console.log('');\n            console.log('  FILTRO DE PERÃODO:');\n            console.log(`    ğŸ“… De ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`);\n        }\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('');\n\n        atualizarModal(cancelado ? 'Cancelado pelo usuÃ¡rio' : 'Finalizado!', true);\n\n        setTimeout(() => {\n            const mensagem = cancelado\n                ? `âš ï¸ PROCESSAMENTO CANCELADO\\n\\n`\n                : `ğŸŠ REENVIO FINALIZADO!\\n\\n`;\n\n            let textoCompleto = mensagem +\n                `ESTA EXECUÃ‡ÃƒO:\\n` +\n                `  âœ… Sucesso: ${estado.totalSucesso}\\n` +\n                `  âŒ Erros: ${estado.totalErro}\\n` +\n                `  â±ï¸ Timeouts: ${estado.totalTimeout}\\n`;\n\n            if (estado.totalPulados > 0) {\n                textoCompleto += `  â­ï¸ Pulados: ${estado.totalPulados}\\n`;\n            }\n\n            textoCompleto +=\n                `  âš¡ Velocidade: ${velocidade} reg/min\\n` +\n                `  ğŸ“‹ Status: ${statusTexto}\\n`;\n                \n            if (analise) {\n                textoCompleto += `  ğŸ“Š P95 final: ${analise.p95}ms\\n`;\n            }\n            \n            textoCompleto +=\n                `\\nCHECKPOINT PERMANENTE:\\n` +\n                `  ğŸ’¾ Total com sucesso: ${resumo.idsSucesso}\\n` +\n                `  ğŸ“Š Total execuÃ§Ãµes: ${resumo.totalExecucoes}\\n`;\n\n            if (CONFIG.habilitarFiltroData) {\n                textoCompleto += `\\nPERÃODO FILTRADO:\\n` +\n                                `  ğŸ“… ${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}\\n`;\n            }\n\n            textoCompleto += `\\nExportar relatÃ³rio CSV?`;\n\n            const confirmExport = confirm(textoCompleto);\n\n            if (confirmExport) {\n                exportarCSV();\n            }\n\n            fecharModal();\n            estado.processando = false;\n        }, 500);\n    }\n\n    // ============================================\n    // ğŸ¨ INTERFACE COM MÃ‰TRICAS AVANÃ‡ADAS\n    // ============================================\n\n    function criarModal() {\n        if (document.getElementById('apiDirectModal')) return;\n\n        const modal = document.createElement('div');\n        modal.id = 'apiDirectModal';\n        modal.innerHTML = `\n            <div style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                        background: rgba(0,0,0,0.7); z-index: 999999; display: flex;\n                        align-items: center; justify-content: center; overflow-y: auto;\">\n                <div style=\"background: white; padding: 30px; border-radius: 8px;\n                            min-width: 650px; max-width: 850px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n                            margin: 20px;\">\n                    <h2 style=\"margin: 0 0 20px 0; color: #00bcd4; text-align: center;\">\n                        ğŸš€ API Direct v${VERSAO}\n                    </h2>\n\n                    <div id=\"apiStatus\" style=\"font-size: 14px; color: #666; margin-bottom: 15px; text-align: center; font-weight: bold;\">\n                        Iniciando...\n                    </div>\n\n                    <div style=\"background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 15px;\">\n                        <div style=\"display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;\">\n                            <div>\n                                <label style=\"font-size: 11px; font-weight: bold; display: block; margin-bottom: 5px;\">\n                                    MÃ­n Workers:\n                                </label>\n                                <input type=\"number\" id=\"workersMin\" value=\"${CONFIG.concorrenciaMinima}\"\n                                       min=\"1\" max=\"200\"\n                                       style=\"width: 100%; padding: 6px; border: 1px solid #90caf9; border-radius: 4px;\">\n                            </div>\n                            \n                            <div style=\"text-align: center;\">\n                                <div style=\"font-weight: bold; font-size: 12px; color: #666; margin-bottom: 5px;\">\n                                    Workers Atual\n                                </div>\n                                <div style=\"font-size: 24px; font-weight: bold; color: #00bcd4; padding: 5px 0;\">\n                                    <span id=\"apiWorkers\">${CONFIG.concorrenciaInicial}</span>\n                                </div>\n                                <div style=\"display: flex; gap: 5px; justify-content: center; margin-top: 5px;\">\n                                    <button onclick=\"window.ajustarWorkers(-5)\"\n                                            style=\"padding: 5px 12px; background: #ff9800; color: white; border: none;\n                                                   border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;\">\n                                        -5\n                                    </button>\n                                    <button onclick=\"window.ajustarWorkers(+5)\"\n                                            style=\"padding: 5px 12px; background: #4caf50; color: white; border: none;\n                                                   border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;\">\n                                        +5\n                                    </button>\n                                </div>\n                            </div>\n                            \n                            <div>\n                                <label style=\"font-size: 11px; font-weight: bold; display: block; margin-bottom: 5px;\">\n                                    MÃ¡x Workers:\n                                </label>\n                                <input type=\"number\" id=\"workersMax\" value=\"${CONFIG.concorrenciaMaxima}\"\n                                       min=\"1\" max=\"200\"\n                                       style=\"width: 100%; padding: 6px; border: 1px solid #90caf9; border-radius: 4px;\">\n                            </div>\n                        </div>\n                        \n                        <button onclick=\"window.aplicarLimitesWorkers()\"\n                                style=\"width: 100%; margin-top: 10px; padding: 8px; background: #2196f3; color: white;\n                                       border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;\">\n                            âœ… Aplicar Limites\n                        </button>\n                    </div>\n\n                    <div style=\"background: #f5f5f5; padding: 20px; border-radius: 4px; margin-bottom: 20px;\">\n                        <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 13px;\">\n                            <div>\n                                <strong>ğŸ“„ PÃ¡ginas:</strong>\n                                <span id=\"apiPaginas\" style=\"float: right; font-weight: bold;\">0/0</span>\n                            </div>\n                            <div>\n                                <strong>ğŸ“Š Buscados:</strong>\n                                <span id=\"apiBuscados\" style=\"float: right; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>âš™ï¸ Processados:</strong>\n                                <span id=\"apiProcessados\" style=\"float: right; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>âœ… Sucesso:</strong>\n                                <span id=\"apiSucesso\" style=\"float: right; color: green; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>âŒ Erros:</strong>\n                                <span id=\"apiErros\" style=\"float: right; color: red; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>â±ï¸ Timeouts:</strong>\n                                <span id=\"apiTimeouts\" style=\"float: right; color: orange; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>â­ï¸ Pulados:</strong>\n                                <span id=\"apiPulados\" style=\"float: right; color: #9c27b0; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>ğŸ”„ Retries:</strong>\n                                <span id=\"apiRetries\" style=\"float: right; color: #795548; font-weight: bold;\">0</span>\n                            </div>\n                            <div>\n                                <strong>â±ï¸ Tempo:</strong>\n                                <span id=\"apiTempo\" style=\"float: right; font-weight: bold;\">0s</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- âœ¨ NOVO: MÃ©tricas de LatÃªncia -->\n                    <div style=\"background: #fff3e0; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ff9800;\">\n                        <div style=\"font-weight: bold; margin-bottom: 10px; color: #e65100;\">\n                            ğŸ“Š MÃ©tricas de LatÃªncia (Ãºltimas 100 req)\n                        </div>\n                        <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 12px;\">\n                            <div>\n                                <strong>P50:</strong>\n                                <span id=\"apiP50\" style=\"float: right; font-weight: bold; color: #2196f3;\">-</span>\n                            </div>\n                            <div>\n                                <strong>P95:</strong>\n                                <span id=\"apiP95\" style=\"float: right; font-weight: bold; color: #ff9800;\">-</span>\n                            </div>\n                            <div>\n                                <strong>P99:</strong>\n                                <span id=\"apiP99\" style=\"float: right; font-weight: bold; color: #f44336;\">-</span>\n                            </div>\n                            <div>\n                                <strong>MÃ©dia:</strong>\n                                <span id=\"apiMedia\" style=\"float: right; font-weight: bold;\">-</span>\n                            </div>\n                            <div>\n                                <strong>Throughput:</strong>\n                                <span id=\"apiThroughput\" style=\"float: right; font-weight: bold; color: #4caf50;\">-</span>\n                            </div>\n                            <div>\n                                <strong>TendÃªncia:</strong>\n                                <span id=\"apiTendencia\" style=\"float: right; font-weight: bold;\">-</span>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <div style=\"display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;\">\n                            <span>Progresso</span>\n                            <span id=\"apiProgresso\">0%</span>\n                        </div>\n                        <div style=\"background: #e0e0e0; height: 30px; border-radius: 4px; overflow: hidden;\">\n                            <div id=\"apiBarraProgresso\" style=\"background: linear-gradient(90deg, #00bcd4, #0097a7);\n                                 height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center;\n                                 justify-content: center; color: white; font-weight: bold; font-size: 14px;\">\n                            </div>\n                        </div>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <div style=\"display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;\">\n                            <span>Taxa de Sucesso</span>\n                            <span id=\"apiTaxaSucesso\">0%</span>\n                        </div>\n                        <div style=\"background: #e0e0e0; height: 20px; border-radius: 4px; overflow: hidden;\">\n                            <div id=\"apiBarraSucesso\" style=\"background: linear-gradient(90deg, #4caf50, #2e7d32);\n                                 height: 100%; width: 0%; transition: width 0.3s;\">\n                            </div>\n                        </div>\n                    </div>\n\n                    <div id=\"apiBotoesControle\" style=\"display: flex; gap: 10px; justify-content: center; margin-bottom: 10px;\">\n                        <button id=\"btnPausar\" onclick=\"window.pausarScript()\"\n                                style=\"padding: 10px 20px; background: #ff9800; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer; font-weight: bold;\">\n                            â¸ï¸ Pausar\n                        </button>\n                        <button id=\"btnCancelar\" onclick=\"window.cancelarScript()\"\n                                style=\"padding: 10px 20px; background: #f44336; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer; font-weight: bold;\">\n                            ğŸ›‘ Cancelar\n                        </button>\n                    </div>\n\n                    <div id=\"apiBotoesFinais\" style=\"display: none; margin-top: 20px; text-align: center;\">\n                        <button onclick=\"document.getElementById('exportarCSVBtn').click()\"\n                                style=\"padding: 10px 20px; background: #4caf50; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer; margin-right: 10px;\">\n                            ğŸ’¾ Exportar CSV\n                        </button>\n                        <button onclick=\"document.getElementById('apiDirectModal').remove()\"\n                                style=\"padding: 10px 20px; background: #666; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer;\">\n                            âœ–ï¸ Fechar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        document.body.appendChild(modal);\n\n        window.pausarScript = function() {\n            if (estado.pausado) {\n                continuarProcessamento();\n            } else {\n                pausarProcessamento();\n            }\n        };\n\n        window.cancelarScript = cancelarProcessamento;\n    }\n\n    function atualizarBotoesDuranteExecucao() {\n        const btnPausar = document.getElementById('btnPausar');\n        if (btnPausar) {\n            if (estado.pausado) {\n                btnPausar.textContent = 'â–¶ï¸ Continuar';\n                btnPausar.style.background = '#4caf50';\n            } else {\n                btnPausar.textContent = 'â¸ï¸ Pausar';\n                btnPausar.style.background = '#ff9800';\n            }\n        }\n    }\n\n    function atualizarModal(status, finalizado = false) {\n        const progresso = estado.totalBuscados > 0\n            ? Math.floor((estado.totalProcessados / estado.totalBuscados) * 100)\n            : 0;\n        const tempoDecorrido = Math.floor((Date.now() - estado.iniciado) / 1000);\n        const velocidade = tempoDecorrido > 0 ? Math.round((estado.totalProcessados / tempoDecorrido) * 60) : 0;\n        const taxaSucesso = estado.totalProcessados > 0\n            ? ((estado.totalSucesso / estado.totalProcessados) * 100).toFixed(1)\n            : 0;\n\n        const analise = analisarPerformance();\n        const tendencia = detectarTendenciaLatencia();\n        \n        const elementos = {\n            apiStatus: status || (estado.pausado ? 'â¸ï¸ PAUSADO' : 'Processando...'),\n            apiPaginas: `${estado.paginaAtual}/${estado.totalPaginas || '?'}`,\n            apiBuscados: estado.totalBuscados,\n            apiProcessados: estado.totalProcessados,\n            apiSucesso: estado.totalSucesso,\n            apiErros: estado.totalErro,\n            apiTimeouts: estado.totalTimeout,\n            apiPulados: estado.totalPulados,\n            apiRetries: estado.totalRetentativas,\n            apiWorkers: estado.concorrenciaAtual,\n            apiProgresso: `${progresso}%`,\n            apiTempo: `${tempoDecorrido}s`,\n            apiTaxaSucesso: `${taxaSucesso}%`,\n            apiP50: analise ? `${analise.p50}ms` : '-',\n            apiP95: analise ? `${analise.p95}ms` : '-',\n            apiP99: analise ? `${analise.p99}ms` : '-',\n            apiMedia: analise ? `${analise.media}ms` : '-',\n            apiThroughput: analise ? `${analise.throughputTeorico} req/s` : '-',\n            apiTendencia: tendencia === 'crescente' ? 'ğŸ“ˆ' : \n                         tendencia === 'decrescente' ? 'ğŸ“‰' : 'â¡ï¸'\n        };\n\n        Object.entries(elementos).forEach(([id, valor]) => {\n            const el = document.getElementById(id);\n            if (el) el.textContent = valor;\n        });\n\n        const p95El = document.getElementById('apiP95');\n        if (p95El && analise) {\n            const ratio = analise.p95 / CONFIG.timeoutRequisicao;\n            if (ratio > 0.8) {\n                p95El.style.color = '#f44336';\n            } else if (ratio > 0.5) {\n                p95El.style.color = '#ff9800';\n            } else {\n                p95El.style.color = '#4caf50';\n            }\n        }\n\n        const barra = document.getElementById('apiBarraProgresso');\n        if (barra) {\n            barra.style.width = `${progresso}%`;\n            barra.textContent = `${progresso}%`;\n        }\n\n        const barraSucesso = document.getElementById('apiBarraSucesso');\n        if (barraSucesso) {\n            barraSucesso.style.width = `${taxaSucesso}%`;\n        }\n\n        if (finalizado) {\n            const controles = document.getElementById('apiBotoesControle');\n            const finais = document.getElementById('apiBotoesFinais');\n            if (controles) controles.style.display = 'none';\n            if (finais) finais.style.display = 'block';\n        }\n    }\n\n    function fecharModal() {\n        const modal = document.getElementById('apiDirectModal');\n        if (modal) modal.remove();\n    }\n\n    function exportarCSV() {\n        const linhas = [\n            ['ID', 'CPF', 'Vacina', 'Status', 'HTTP Status', 'Tentativa', 'LatÃªncia (ms)', 'Erro', 'Timestamp'].join(';')\n        ];\n\n        estado.resultados.forEach(r => {\n            linhas.push([\n                r.id,\n                r.cpf,\n                r.vacina,\n                r.status,\n                r.statusCode,\n                r.tentativa,\n                r.latencia || '-',\n                (r.erro || '').replace(/;/g, ','),\n                r.timestamp\n            ].join(';'));\n        });\n\n        const resumo = checkpointManager.getResumo();\n        const analise = analisarPerformance();\n\n        const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'ERROR' :\n                           CONFIG.statusBuscar === 'PENDING' ? 'PENDING' :\n                           'ERROR + PENDING';\n                           \n        const taxaSucesso = estado.totalProcessados > 0 \n            ? ((estado.totalSucesso / estado.totalProcessados) * 100).toFixed(1) \n            : 0;\n\n        linhas.push('');\n        linhas.push('ESTATÃSTICAS DESTA EXECUÃ‡ÃƒO');\n        linhas.push(`Status Buscados;${statusTexto}`);\n        linhas.push(`Total Buscados;${estado.totalBuscados}`);\n        linhas.push(`Total PÃ¡ginas;${estado.paginaAtual}`);\n        linhas.push(`Total Processados;${estado.totalProcessados}`);\n        linhas.push(`Total Pulados (Sucesso Anterior);${estado.totalPulados}`);\n        linhas.push(`Sucesso;${estado.totalSucesso}`);\n        linhas.push(`Erros;${estado.totalErro}`);\n        linhas.push(`Timeouts;${estado.totalTimeout}`);\n        linhas.push(`Retentativas;${estado.totalRetentativas}`);\n        linhas.push(`Tempo Total;${Math.floor((Date.now() - estado.iniciado) / 1000)}s`);\n        linhas.push(`Velocidade;${Math.round((estado.totalProcessados / ((Date.now() - estado.iniciado) / 1000)) * 60)} reg/min`);\n        linhas.push(`Taxa Sucesso;${taxaSucesso}%`);\n\n        if (analise) {\n            linhas.push('');\n            linhas.push('MÃ‰TRICAS DE LATÃŠNCIA');\n            linhas.push(`P50;${analise.p50}ms`);\n            linhas.push(`P95;${analise.p95}ms`);\n            linhas.push(`P99;${analise.p99}ms`);\n            linhas.push(`MÃ©dia;${analise.media}ms`);\n            linhas.push(`Throughput;${analise.throughputTeorico} req/s`);\n        }\n\n        linhas.push('');\n        linhas.push('CHECKPOINT PERMANENTE');\n        linhas.push(`Total IDs com Sucesso;${resumo.idsSucesso}`);\n        linhas.push(`Total ExecuÃ§Ãµes;${resumo.totalExecucoes}`);\n\n        if (CONFIG.habilitarFiltroData) {\n            linhas.push('');\n            linhas.push('FILTRO DE PERÃODO');\n            linhas.push(`Data InÃ­cio;${CONFIG.dataInicio}`);\n            linhas.push(`Data Fim;${CONFIG.dataFim}`);\n        }\n\n        const csv = '\\uFEFF' + linhas.join('\\n');\n        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n        const objectUrl = URL.createObjectURL(blob);\n        \n        const link = document.createElement('a');\n        link.href = objectUrl;\n        link.download = `reenvio_api_v${VERSAO}_${new Date().toISOString().split('T')[0]}.csv`;\n        link.id = 'exportarCSVBtn';\n        link.click();\n\n        setTimeout(() => URL.revokeObjectURL(objectUrl), 200);\n\n        console.log('ğŸ’¾ CSV exportado!');\n    }\n\n    // ============================================\n    // âš™ï¸ CONFIGURAÃ‡Ã•ES\n    // ============================================\n\n    function abrirConfiguracoes() {\n        const modalConfig = document.createElement('div');\n        modalConfig.id = 'modalConfiguracoes';\n        \n        const errorChecked = CONFIG.statusBuscar === 'ERROR' ? 'checked' : '';\n        const pendingChecked = CONFIG.statusBuscar === 'PENDING' ? 'checked' : '';\n        const ambosChecked = CONFIG.statusBuscar === 'AMBOS' ? 'checked' : '';\n        \n        modalConfig.innerHTML = `\n            <div style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n                        background: rgba(0,0,0,0.7); z-index: 999999; display: flex;\n                        align-items: center; justify-content: center;\">\n                <div style=\"background: white; padding: 30px; border-radius: 8px;\n                            width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);\">\n                    <h2 style=\"margin: 0 0 20px 0; color: #00bcd4;\">âš™ï¸ ConfiguraÃ§Ãµes</h2>\n\n                    <div style=\"margin-bottom: 20px; background: #e8f5e9; padding: 15px; border-radius: 4px; border: 2px solid #4caf50;\">\n                        <label style=\"display: block; margin-bottom: 10px; font-weight: bold; font-size: 16px; color: #2e7d32;\">\n                            ğŸ“‹ Status dos Registros a Buscar\n                        </label>\n                        <div style=\"margin-bottom: 10px;\">\n                            <label style=\"display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;\">\n                                <input type=\"radio\" name=\"statusBuscar\" value=\"ERROR\" ${errorChecked}\n                                       style=\"margin-right: 10px; width: 18px; height: 18px; cursor: pointer;\">\n                                <div>\n                                    <strong>âŒ Apenas ERROR</strong>\n                                    <div style=\"font-size: 12px; color: #666; margin-top: 2px;\">\n                                        Busca somente registros com erro no envio\n                                    </div>\n                                </div>\n                            </label>\n                            <label style=\"display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px; margin-bottom: 8px;\">\n                                <input type=\"radio\" name=\"statusBuscar\" value=\"PENDING\" ${pendingChecked}\n                                       style=\"margin-right: 10px; width: 18px; height: 18px; cursor: pointer;\">\n                                <div>\n                                    <strong>â³ Apenas PENDING</strong>\n                                    <div style=\"font-size: 12px; color: #666; margin-top: 2px;\">\n                                        Busca somente registros pendentes de envio\n                                    </div>\n                                </div>\n                            </label>\n                            <label style=\"display: flex; align-items: center; cursor: pointer; padding: 8px; background: white; border-radius: 4px;\">\n                                <input type=\"radio\" name=\"statusBuscar\" value=\"AMBOS\" ${ambosChecked}\n                                       style=\"margin-right: 10px; width: 18px; height: 18px; cursor: pointer;\">\n                                <div>\n                                    <strong>ğŸ“‹ AMBOS (ERROR + PENDING)</strong>\n                                    <div style=\"font-size: 12px; color: #666; margin-top: 2px;\">\n                                        Busca registros com erro E pendentes (recomendado)\n                                    </div>\n                                </div>\n                            </label>\n                        </div>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            âš¡ ConcorrÃªncia Inicial:\n                        </label>\n                        <input type=\"number\" id=\"cfgConcorrenciaInicial\" value=\"${CONFIG.concorrenciaInicial}\"\n                               min=\"1\" max=\"100\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            ğŸš€ ConcorrÃªncia MÃ¡xima:\n                        </label>\n                        <input type=\"number\" id=\"cfgConcorrenciaMaxima\" value=\"${CONFIG.concorrenciaMaxima}\"\n                               min=\"1\" max=\"200\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            ğŸ“„ Registros por PÃ¡gina:\n                        </label>\n                        <input type=\"number\" id=\"cfgRegistrosPorPagina\" value=\"${CONFIG.registrosPorPagina}\"\n                               min=\"10\" max=\"1000\" step=\"10\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                        <small style=\"color: #666;\">âš ï¸ Recomendado: 15 (mesmo valor da aplicaÃ§Ã£o)</small>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            â±ï¸ Timeout por RequisiÃ§Ã£o (ms):\n                        </label>\n                        <input type=\"number\" id=\"cfgTimeoutRequisicao\" value=\"${CONFIG.timeoutRequisicao}\"\n                               min=\"5000\" max=\"120000\" step=\"1000\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                        <small style=\"color: #666;\">\n                            Tempo mÃ¡ximo de espera por requisiÃ§Ã£o (ms). \n                            <strong>${(CONFIG.timeoutRequisicao / 1000)}s atual</strong>\n                        </small>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            ğŸ”„ MÃ¡ximo de Retentativas:\n                        </label>\n                        <input type=\"number\" id=\"cfgMaxRetentativas\" value=\"${CONFIG.maxRetentativas}\"\n                               min=\"0\" max=\"5\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: block; margin-bottom: 5px; font-weight: bold;\">\n                            ğŸ“„ Limite MÃ¡ximo de PÃ¡ginas:\n                        </label>\n                        <input type=\"number\" id=\"cfgLimitePaginas\" value=\"${CONFIG.limiteMaximoPaginas}\"\n                               min=\"10\" max=\"1000\" step=\"10\"\n                               style=\"width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;\">\n                        <small style=\"color: #666;\">SeguranÃ§a para nÃ£o buscar infinitamente</small>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px;\">\n                        <label style=\"display: flex; align-items: center; cursor: pointer;\">\n                            <input type=\"checkbox\" id=\"cfgAjusteAuto\" ${CONFIG.ajusteAutomatico ? 'checked' : ''}\n                                   style=\"margin-right: 10px; width: 20px; height: 20px; cursor: pointer;\">\n                            <span style=\"font-weight: bold;\">ğŸ¯ Ajuste AutomÃ¡tico de ConcorrÃªncia</span>\n                        </label>\n                    </div>\n\n                    <div style=\"margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 4px;\">\n                        <label style=\"display: flex; align-items: center; cursor: pointer;\">\n                            <input type=\"checkbox\" id=\"cfgCheckpoint\" ${CONFIG.habilitarCheckpoint ? 'checked' : ''}\n                                   style=\"margin-right: 10px; width: 20px; height: 20px; cursor: pointer;\">\n                            <span style=\"font-weight: bold;\">ğŸ’¾ Checkpoint Permanente</span>\n                        </label>\n                        <small style=\"color: #666; display: block; margin-top: 5px;\">\n                            âœ… Salva apenas sucessos<br>\n                            âœ… Acumula entre execuÃ§Ãµes<br>\n                            âœ… Nunca limpa automaticamente\n                        </small>\n                    </div>\n\n                    <hr style=\"margin: 25px 0; border: none; border-top: 2px solid #e0e0e0;\">\n\n                    <div style=\"margin-bottom: 20px; background: #fff3e0; padding: 15px; border-radius: 4px; border: 2px solid #ff9800;\">\n                        <label style=\"display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;\">\n                            <input type=\"checkbox\" id=\"cfgFiltroData\" ${CONFIG.habilitarFiltroData ? 'checked' : ''}\n                                   onchange=\"document.getElementById('divDatasConfig').style.display = this.checked ? 'block' : 'none'\"\n                                   style=\"margin-right: 10px; width: 20px; height: 20px; cursor: pointer;\">\n                            <span style=\"font-weight: bold; font-size: 16px;\">ğŸ“… Filtro de PerÃ­odo de Datas</span>\n                        </label>\n\n                        <div id=\"divDatasConfig\" style=\"display: ${CONFIG.habilitarFiltroData ? 'block' : 'none'};\">\n                            <div style=\"margin-bottom: 15px;\">\n                                <label style=\"display: block; margin-bottom: 5px; font-weight: bold; color: #555;\">\n                                    ğŸ“† Data InÃ­cio:\n                                </label>\n                                <input type=\"date\" id=\"cfgDataInicio\" value=\"${CONFIG.dataInicio}\"\n                                       style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;\">\n                                <small style=\"color: #666;\">Data da vacinaÃ§Ã£o (inÃ­cio do perÃ­odo)</small>\n                            </div>\n\n                            <div style=\"margin-bottom: 10px;\">\n                                <label style=\"display: block; margin-bottom: 5px; font-weight: bold; color: #555;\">\n                                    ğŸ“† Data Fim:\n                                </label>\n                                <input type=\"date\" id=\"cfgDataFim\" value=\"${CONFIG.dataFim}\"\n                                       style=\"width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;\">\n                                <small style=\"color: #666;\">Data da vacinaÃ§Ã£o (fim do perÃ­odo)</small>\n                            </div>\n\n                            <div style=\"background: #e8f5e9; padding: 10px; border-radius: 4px; margin-top: 10px;\">\n                                <small style=\"color: #2e7d32; font-weight: bold;\">\n                                    ğŸ’¡ Dica: Use este filtro para processar registros de um perÃ­odo especÃ­fico.<br>\n                                    âš ï¸ Desmarque para buscar TODOS os registros (sem filtro de data).\n                                </small>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div style=\"display: flex; gap: 10px; justify-content: flex-end;\">\n                        <button onclick=\"document.getElementById('modalConfiguracoes').remove()\"\n                                style=\"padding: 10px 20px; background: #666; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer;\">\n                            Cancelar\n                        </button>\n                        <button id=\"btnSalvarConfig\"\n                                style=\"padding: 10px 20px; background: #4caf50; color: white; border: none;\n                                       border-radius: 4px; cursor: pointer; font-weight: bold;\">\n                            ğŸ’¾ Salvar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;\n\n        document.body.appendChild(modalConfig);\n\n        document.getElementById('btnSalvarConfig').onclick = () => {\n            CONFIG.concorrenciaInicial = parseInt(document.getElementById('cfgConcorrenciaInicial').value);\n            CONFIG.concorrenciaMaxima = parseInt(document.getElementById('cfgConcorrenciaMaxima').value);\n            CONFIG.registrosPorPagina = parseInt(document.getElementById('cfgRegistrosPorPagina').value);\n            CONFIG.timeoutRequisicao = parseInt(document.getElementById('cfgTimeoutRequisicao').value);\n            CONFIG.maxRetentativas = parseInt(document.getElementById('cfgMaxRetentativas').value);\n            CONFIG.limiteMaximoPaginas = parseInt(document.getElementById('cfgLimitePaginas').value);\n            CONFIG.ajusteAutomatico = document.getElementById('cfgAjusteAuto').checked;\n            CONFIG.habilitarCheckpoint = document.getElementById('cfgCheckpoint').checked;\n\n            const statusSelecionado = document.querySelector('input[name=\"statusBuscar\"]:checked');\n            if (statusSelecionado) {\n                CONFIG.statusBuscar = statusSelecionado.value;\n            }\n\n            if (CONFIG.timeoutRequisicao < 5000) {\n                alert('âš ï¸ Timeout muito baixo! MÃ­nimo recomendado: 5000ms (5s)');\n                return;\n            }\n\n            if (CONFIG.timeoutRequisicao > 120000) {\n                if (!confirm(\n                    'âš ï¸ Timeout muito alto!\\n\\n' +\n                    `Timeout configurado: ${CONFIG.timeoutRequisicao}ms (${CONFIG.timeoutRequisicao/1000}s)\\n\\n` +\n                    'Timeouts altos podem travar o processamento se houver problemas na rede.\\n\\n' +\n                    'Continuar mesmo assim?'\n                )) {\n                    return;\n                }\n            }\n\n            CONFIG.habilitarFiltroData = document.getElementById('cfgFiltroData').checked;\n            CONFIG.dataInicio = document.getElementById('cfgDataInicio').value;\n            CONFIG.dataFim = document.getElementById('cfgDataFim').value;\n\n            if (CONFIG.habilitarFiltroData) {\n                const inicio = new Date(CONFIG.dataInicio);\n                const fim = new Date(CONFIG.dataFim);\n\n                if (inicio > fim) {\n                    alert('âš ï¸ Data de inÃ­cio nÃ£o pode ser maior que data de fim!');\n                    return;\n                }\n\n                const hoje = new Date();\n                hoje.setHours(0, 0, 0, 0);\n\n                if (fim > hoje) {\n                    if (!confirm(\n                        'âš ï¸ Data de fim estÃ¡ no futuro!\\n\\n' +\n                        `Data fim: ${CONFIG.dataFim}\\n` +\n                        `Hoje: ${hoje.toISOString().split('T')[0]}\\n\\n` +\n                        'Continuar mesmo assim?'\n                    )) {\n                        return;\n                    }\n                }\n            }\n\n            localStorage.setItem('RNDS_CONFIG', JSON.stringify(CONFIG));\n\n            const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'apenas ERROR' :\n                               CONFIG.statusBuscar === 'PENDING' ? 'apenas PENDING' :\n                               'ERROR + PENDING (ambos)';\n\n            let msg = 'âœ… ConfiguraÃ§Ãµes salvas!\\n\\n';\n            msg += `ğŸ“‹ Status: ${statusTexto}\\n`;\n            msg += `â±ï¸ Timeout: ${CONFIG.timeoutRequisicao}ms (${CONFIG.timeoutRequisicao/1000}s)\\n`;\n            \n            if (CONFIG.habilitarFiltroData) {\n                msg += `\\nğŸ“… Filtro de perÃ­odo ATIVO:\\n${CONFIG.dataInicio} atÃ© ${CONFIG.dataFim}`;\n            } else {\n                msg += '\\nğŸ“… Filtro de perÃ­odo DESATIVADO (buscarÃ¡ todos os registros)';\n            }\n\n            alert(msg);\n            document.getElementById('modalConfiguracoes').remove();\n\n            console.log('âš™ï¸ Novas configuraÃ§Ãµes:', CONFIG);\n        };\n    }\n\n    function carregarConfiguracoes() {\n        const configSalva = localStorage.getItem('RNDS_CONFIG');\n        if (configSalva) {\n            try {\n                const config = JSON.parse(configSalva);\n                Object.assign(CONFIG, config);\n                console.log('âœ… ConfiguraÃ§Ãµes carregadas:', CONFIG);\n            } catch (e) {\n                console.warn('âš ï¸ Erro ao carregar configuraÃ§Ãµes');\n            }\n        }\n    }\n\n    function gerenciarCheckpoint() {\n        const resumo = checkpointManager.getResumo();\n\n        if (!resumo) {\n            alert('â„¹ï¸ Nenhum checkpoint encontrado');\n            return;\n        }\n\n        const historico = checkpointManager.getHistorico();\n        let mensagem = 'ğŸ’¾ CHECKPOINT PERMANENTE\\n\\n' +\n                      `Data: ${resumo.dataCheckpoint.toLocaleString()}\\n` +\n                      `IDs com SUCESSO: ${resumo.idsSucesso}\\n` +\n                      `ExecuÃ§Ãµes: ${resumo.totalExecucoes}\\n\\n`;\n\n        if (historico.length > 0) {\n            mensagem += 'HISTÃ“RICO:\\n';\n            historico.slice(-5).forEach(h => {\n                mensagem += `  ${h.numero}. ${h.data} - ${h.sucessos} sucessos\\n`;\n            });\n            mensagem += '\\n';\n        }\n\n        mensagem +=\n            'âœ… IDs com sucesso sÃ£o PERMANENTES\\n' +\n            'âœ… SerÃ£o pulados em TODAS as execuÃ§Ãµes\\n' +\n            'ğŸ”„ Erros/timeouts tentados novamente\\n\\n' +\n            'Deseja LIMPAR o checkpoint permanente?';\n\n        if (confirm(mensagem)) {\n            checkpointManager.limpar();\n        }\n    }\n\n    // ============================================\n    // ğŸ¨ TOOLBAR\n    // ============================================\n\n    function criarBotoesToolbar() {\n        const toolbar = document.querySelector('.main-theme-options');\n        if (!toolbar) {\n            console.log('â³ Aguardando toolbar...');\n            setTimeout(criarBotoesToolbar, 500);\n            return;\n        }\n\n        console.log('âœ… Toolbar encontrada!');\n\n        const divider = document.createElement('nab-divider');\n        divider.setAttribute('role', 'separator');\n        divider.className = 'nab-divider nab-divider-white nab-divider-vertical';\n        divider.setAttribute('aria-orientation', 'vertical');\n\n        const btnToken = document.createElement('button');\n        btnToken.id = 'btnVerToken';\n        btnToken.className = 'nab-focus-indicator nab-icon-button nab-button-base';\n        btnToken.setAttribute('nab-icon-button', '');\n        btnToken.title = 'Ver/Inserir Token';\n        btnToken.innerHTML = `\n            <span class=\"nab-button-wrapper\">\n                <span class=\"icon-emoji\" style=\"font-size: 20px; color: #ff9800;\">ğŸ”‘</span>\n            </span>\n        `;\n        btnToken.onclick = () => {\n            if (TOKEN_GLOBAL) {\n                const copiar = confirm(`ğŸ”‘ TOKEN:\\n\\n${TOKEN_GLOBAL}\\n\\n\\nCopiar?`);\n                if (copiar) {\n                    navigator.clipboard.writeText(TOKEN_GLOBAL);\n                    alert('âœ… Token copiado!');\n                }\n            } else {\n                solicitarTokenManual();\n            }\n        };\n\n        const btnCheckpoint = document.createElement('button');\n        btnCheckpoint.id = 'btnCheckpoint';\n        btnCheckpoint.className = 'nab-focus-indicator nab-icon-button nab-button-base';\n        btnCheckpoint.setAttribute('nab-icon-button', '');\n        btnCheckpoint.title = 'Gerenciar Checkpoint';\n        btnCheckpoint.innerHTML = `\n            <span class=\"nab-button-wrapper\">\n                <span class=\"icon-emoji\" style=\"font-size: 20px; color: #2196f3;\">ğŸ’¾</span>\n            </span>\n        `;\n        btnCheckpoint.onclick = gerenciarCheckpoint;\n\n        const btnConfig = document.createElement('button');\n        btnConfig.id = 'btnConfiguracoes';\n        btnConfig.className = 'nab-focus-indicator nab-icon-button nab-button-base';\n        btnConfig.setAttribute('nab-icon-button', '');\n        btnConfig.title = 'ConfiguraÃ§Ãµes';\n        btnConfig.innerHTML = `\n            <span class=\"nab-button-wrapper\">\n                <span class=\"icon-emoji\" style=\"font-size: 20px; color: #9c27b0;\">âš™ï¸</span>\n            </span>\n        `;\n        btnConfig.onclick = abrirConfiguracoes;\n\n        const btnReenviar = document.createElement('button');\n        btnReenviar.id = 'btnReenviarAPI';\n        btnReenviar.className = 'nab-focus-indicator nab-icon-button nab-button-base';\n        btnReenviar.setAttribute('nab-icon-button', '');\n        btnReenviar.title = 'Reenviar Vacinas';\n        btnReenviar.innerHTML = `\n            <span class=\"nab-button-wrapper\">\n                <span class=\"icon-emoji\" style=\"font-size: 20px; color: #00bcd4;\">ğŸš€</span>\n            </span>\n        `;\n        btnReenviar.onclick = iniciarReenvioAPI;\n\n        const btnGlobal = toolbar.querySelector('button[nab-icon-button]');\n        if (btnGlobal) {\n            toolbar.insertBefore(divider, btnGlobal);\n            toolbar.insertBefore(btnToken, btnGlobal);\n            toolbar.insertBefore(btnCheckpoint, btnGlobal);\n            toolbar.insertBefore(btnConfig, btnGlobal);\n            toolbar.insertBefore(btnReenviar, btnGlobal);\n        } else {\n            toolbar.appendChild(divider);\n            toolbar.appendChild(btnToken);\n            toolbar.appendChild(btnCheckpoint);\n            toolbar.appendChild(btnConfig);\n            toolbar.appendChild(btnReenviar);\n        }\n\n        console.log('âœ… BotÃµes adicionados!');\n        atualizarBotaoToken(!!TOKEN_GLOBAL);\n\n        if (checkpointManager.getResumo() && checkpointManager.checkpoint.idsSucesso.length > 0) {\n            const icon = btnCheckpoint.querySelector('span.icon-emoji');\n            if (icon) icon.style.color = '#4caf50';\n        }\n    }\n\n    // ============================================\n    // ğŸš€ INICIALIZAÃ‡ÃƒO\n    // ============================================\n\n    function inicializar() {\n        console.log('');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log(`ğŸš€ SPRNDS - API Direct v${VERSAO}`);\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('âœ¨ NOVO NA v13.4.7:');\n        console.log('  â€¢ CorreÃ§Ã£o de race condition no pool de workers');\n        console.log('  â€¢ Adicionada centralizaÃ§Ã£o da string de versÃ£o');\n        console.log('  â€¢ CorreÃ§Ã£o da divisÃ£o por zero ao exportar CSV vazio');\n        console.log('  â€¢ Melhoria no encerramento das promises dos workers');\n        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');\n        console.log('');\n\n        carregarConfiguracoes();\n        capturarToken();\n        criarBotoesToolbar();\n\n        const resumo = checkpointManager.getResumo();\n        if (resumo && resumo.idsSucesso > 0) {\n            console.log('ğŸ’¾ Checkpoint permanente detectado:');\n            console.log(`   â€¢ Data: ${resumo.dataCheckpoint.toLocaleString()}`);\n            console.log(`   â€¢ IDs com SUCESSO: ${resumo.idsSucesso}`);\n            console.log(`   â€¢ ExecuÃ§Ãµes anteriores: ${resumo.totalExecucoes}`);\n            console.log('');\n        }\n\n        const statusTexto = CONFIG.statusBuscar === 'ERROR' ? 'apenas ERROR' :\n                           CONFIG.statusBuscar === 'PENDING' ? 'apenas PENDING' :\n                           'ERROR + PENDING';\n        console.log(`ğŸ“‹ Status configurado: ${statusTexto}`);\n\n        if (CONFIG.habilitarFiltroData) {\n            console.log('ğŸ“… Filtro de perÃ­odo ATIVO:');\n            console.log(`   â€¢ De: ${CONFIG.dataInicio}`);\n            console.log(`   â€¢ AtÃ©: ${CONFIG.dataFim}`);\n            console.log('');\n        } else {\n            console.log('ğŸ“… Filtro de perÃ­odo DESATIVADO (buscando todos)');\n            console.log('');\n        }\n\n        console.log('ğŸ’¡ Sistema pronto!');\n        console.log('');\n    }\n\n    if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', inicializar);\n    } else {\n        inicializar();\n    }\n\n})();