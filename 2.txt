// ==UserScript==
// @name         Reliable Proximo Clicker
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  Robust next-page handling with video detection
// @author       Your Name
// @match        *://universidademv.com.br/lms/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const CONFIG = {
        DEBUG: true,
        TARGET_TEXT: 'Este vídeo já foi visualizado',
        BUTTON_TEXT: 'Próximo',
        VIDEO_SELECTOR: 'iframe#vimeoContentlink',
        CHECK_DELAY: 30000,
        RETRY_LIMIT: 999999999999
    };

    let isActive = true;
    let retryCount = 0;

    function log(...args) {
        CONFIG.DEBUG && console.log('[ProximoUltra]', ...args);
    }

    function findNextButton() {
        const buttons = Array.from(document.querySelectorAll('button.btn-primary'));
        return buttons.find(btn => {
            const span = btn.querySelector('span.texto-btn-player');
            return span && span.textContent.trim() === CONFIG.BUTTON_TEXT && !btn.disabled;
        });
    }

    function checkAndClick() {
        if (!isActive) return;

        // 1. Check for success message
        const successDiv = Array.from(document.querySelectorAll('.alert.alert-success'))
            .find(div => div.textContent.includes(CONFIG.TARGET_TEXT));

        // 2. Check if video is missing
        const videoMissing = !document.querySelector(CONFIG.VIDEO_SELECTOR);

        if (successDiv || videoMissing) {
            const button = findNextButton();
            if (button) {
                log('Clicking verified button');
                button.click();
                resetForNewPage();
                return true;
            }
        }
        return false;
    }

    function resetForNewPage() {
        log('Preparing for new page');
        isActive = false;
        retryCount = 0;

        // Wait for new page to settle
        setTimeout(() => {
            isActive = true;
            startMonitoring();
        }, 5000);
    }

    function startMonitoring() {
        if (retryCount++ > CONFIG.RETRY_LIMIT) {
            log('Retry limit reached');
            return;
        }

        log(`Monitoring attempt ${retryCount}`);

        if (checkAndClick()) return;

        // Setup periodic checks
        const checkInterval = setInterval(() => {
            if (checkAndClick()) {
                clearInterval(checkInterval);
            }
        }, 2000);

        // Cleanup if no action needed
        setTimeout(() => {
            clearInterval(checkInterval);
            if (isActive) startMonitoring();
        }, CONFIG.CHECK_DELAY);
    }

    // Start initial monitoring
    window.addEventListener('load', () => {
        log('Page loaded - starting monitor');
        setTimeout(startMonitoring, 3000);
    });

    // Handle AJAX page transitions
    new MutationObserver(mutations => {
        if (document.querySelector(CONFIG.VIDEO_SELECTOR)) {
            log('New video container detected');
            resetForNewPage();
        }
    }).observe(document.body, {
        childList: true,
        subtree: true
    });
})();